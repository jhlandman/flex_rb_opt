<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 An empirical test using Sourth African equities | Flexible risk-based portfolio optimisation (Github link)</title>
  <meta name="description" content="Flexible risk-based portfolio optimisation
<a href="https://github.com/jhlandman/flex_rb_opt"><em>(Github link)</em></a>" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="7 An empirical test using Sourth African equities | Flexible risk-based portfolio optimisation (Github link)" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="jhlandman/flex_rb_opt" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 An empirical test using Sourth African equities | Flexible risk-based portfolio optimisation (Github link)" />
  
  
  



<meta name="date" content="2020-08-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="somemaths.html"/>
<link rel="next" href="conclusion.html"/>
<style type="text/css">
p.abstract{
  text-align: center;
  font-weight: bold;
}
div.abstract{
  margin: auto;
  width: 90%;
}
</style>
<script src="book_assets/header-attrs-2.3/header-attrs.js"></script>
<script src="book_assets/jquery-2.2.3/jquery.min.js"></script>
<link href="book_assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="book_assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="book_assets/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="genframework.html"><a href="genframework.html"><i class="fa fa-check"></i><b>3</b> A framework for constructing risk-based portfolios</a>
<ul>
<li class="chapter" data-level="3.1" data-path="genframework.html"><a href="genframework.html#mpt"><i class="fa fa-check"></i><b>3.1</b> An overview of modern portfolio theory</a></li>
<li class="chapter" data-level="3.2" data-path="genframework.html"><a href="genframework.html#introducing-risk-based-investing"><i class="fa fa-check"></i><b>3.2</b> Introducing risk-based investing</a></li>
<li class="chapter" data-level="3.3" data-path="genframework.html"><a href="genframework.html#improving-risk-based-portfolios"><i class="fa fa-check"></i><b>3.3</b> Improving risk-based portfolios</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="rbportch.html"><a href="rbportch.html"><i class="fa fa-check"></i><b>4</b> Overview of risk-based portfolios</a>
<ul>
<li class="chapter" data-level="4.1" data-path="rbportch.html"><a href="rbportch.html#risk-based-portfolio-types"><i class="fa fa-check"></i><b>4.1</b> Risk-based portfolio types</a></li>
<li class="chapter" data-level="4.2" data-path="rbportch.html"><a href="rbportch.html#risk-based-portfolio-properties"><i class="fa fa-check"></i><b>4.2</b> Risk-based portfolio properties</a></li>
<li class="chapter" data-level="4.3" data-path="rbportch.html"><a href="rbportch.html#code"><i class="fa fa-check"></i><b>4.3</b> Code</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="rbportch.html"><a href="rbportch.html#mw-portfolio"><i class="fa fa-check"></i><b>4.3.1</b> MW portfolio</a></li>
<li class="chapter" data-level="4.3.2" data-path="rbportch.html"><a href="rbportch.html#ew-portfolio"><i class="fa fa-check"></i><b>4.3.2</b> EW portfolio</a></li>
<li class="chapter" data-level="4.3.3" data-path="rbportch.html"><a href="rbportch.html#gmv-portfolio"><i class="fa fa-check"></i><b>4.3.3</b> GMV portfolio</a></li>
<li class="chapter" data-level="4.3.4" data-path="rbportch.html"><a href="rbportch.html#erc-portfolio"><i class="fa fa-check"></i><b>4.3.4</b> ERC portfolio</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="estriskreduce.html"><a href="estriskreduce.html"><i class="fa fa-check"></i><b>5</b> Estimation risk reduction techniques</a>
<ul>
<li class="chapter" data-level="5.1" data-path="estriskreduce.html"><a href="estriskreduce.html#improving-optimisation-inputs"><i class="fa fa-check"></i><b>5.1</b> Improving optimisation inputs</a></li>
<li class="chapter" data-level="5.2" data-path="estriskreduce.html"><a href="estriskreduce.html#penalising-the-optimization"><i class="fa fa-check"></i><b>5.2</b> Penalising the optimization</a></li>
<li class="chapter" data-level="5.3" data-path="estriskreduce.html"><a href="estriskreduce.html#alternate-implementation-methods"><i class="fa fa-check"></i><b>5.3</b> Alternate implementation methods</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="somemaths.html"><a href="somemaths.html"><i class="fa fa-check"></i><b>6</b> Using estimation risk reduction techniques</a>
<ul>
<li class="chapter" data-level="6.1" data-path="somemaths.html"><a href="somemaths.html#quantile-factor-modelling-and-regime-switching"><i class="fa fa-check"></i><b>6.1</b> Quantile factor modelling and regime switching</a></li>
<li class="chapter" data-level="6.2" data-path="somemaths.html"><a href="somemaths.html#ridge-regression"><i class="fa fa-check"></i><b>6.2</b> Ridge regression</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="experiment.html"><a href="experiment.html"><i class="fa fa-check"></i><b>7</b> An empirical test using Sourth African equities</a>
<ul>
<li class="chapter" data-level="7.1" data-path="experiment.html"><a href="experiment.html#data-and-methodology"><i class="fa fa-check"></i><b>7.1</b> Data and methodology</a></li>
<li class="chapter" data-level="7.2" data-path="experiment.html"><a href="experiment.html#results"><i class="fa fa-check"></i><b>7.2</b> Results</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="experiment.html"><a href="experiment.html#going-to-rify"><i class="fa fa-check"></i><b>7.2.1</b> going to R’ify</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="rbportch.html"><a href="rbportch.html#code"><i class="fa fa-check"></i><b>7.3</b> Code</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="experiment.html"><a href="experiment.html#data-reading-in-and-cleaning"><i class="fa fa-check"></i><b>7.3.1</b> Data reading in and cleaning</a></li>
<li class="chapter" data-level="7.3.2" data-path="experiment.html"><a href="experiment.html#data-preparation-sample-window-history-adjustment"><i class="fa fa-check"></i><b>7.3.2</b> Data preparation (sample window history adjustment)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>8</b> Conclusion</a>
<ul>
<li class="chapter" data-level="8.1" data-path="conclusion.html"><a href="conclusion.html#avenues-for-further-research"><i class="fa fa-check"></i><b>8.1</b> Avenues for further research</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="abbreviations.html"><a href="abbreviations.html"><i class="fa fa-check"></i><b>A</b> Abbreviations</a></li>
<li class="chapter" data-level="B" data-path="portfolio-mathematics.html"><a href="portfolio-mathematics.html"><i class="fa fa-check"></i><b>B</b> Portfolio mathematics</a>
<ul>
<li class="chapter" data-level="B.1" data-path="portfolio-mathematics.html"><a href="portfolio-mathematics.html#mrcapp"><i class="fa fa-check"></i><b>B.1</b> Marginal risk contribution</a></li>
<li class="chapter" data-level="B.2" data-path="portfolio-mathematics.html"><a href="portfolio-mathematics.html#ihimax"><i class="fa fa-check"></i><b>B.2</b> Minimum weight constrained IHI</a></li>
<li class="chapter" data-level="B.3" data-path="portfolio-mathematics.html"><a href="portfolio-mathematics.html#volineq"><i class="fa fa-check"></i><b>B.3</b> Proof of the volatility order inequality</a></li>
<li class="chapter" data-level="B.4" data-path="portfolio-mathematics.html"><a href="portfolio-mathematics.html#msrrbport"><i class="fa fa-check"></i><b>B.4</b> Maximum Sharpe ratio risk-based portfolios</a></li>
</ul></li>
<li class="chapter" data-level="C" data-path="reducing-estimation-error.html"><a href="reducing-estimation-error.html"><i class="fa fa-check"></i><b>C</b> Reducing estimation error</a>
<ul>
<li class="chapter" data-level="C.1" data-path="reducing-estimation-error.html"><a href="reducing-estimation-error.html#qfmexample"><i class="fa fa-check"></i><b>C.1</b> Quantile factor modelling example</a></li>
<li class="chapter" data-level="C.2" data-path="reducing-estimation-error.html"><a href="reducing-estimation-error.html#etaest"><i class="fa fa-check"></i><b>C.2</b> Estimating the ERC portfolio Lagrangian multiplier</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Flexible risk-based portfolio optimisation
<a href="https://github.com/jhlandman/flex_rb_opt"><em>(Github link)</em></a></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="experiment" class="section level1" number="7">
<h1><span class="header-section-number">7</span> An empirical test using Sourth African equities</h1>
<p>In this chapter, we test the various approaches outlined above for constructing risk-based portfolios
using South African equity data. There are two sources of variation in this experiment: variation in
risk-based portfolio type and variation in estimation risk reduction technique, all combinations of
which are outlined in table <a href="somemaths.html#tab:portestpairs">6.1</a>. Each combination of portfolio-technique approach
will be referred to as a pair.</p>
<div id="data-and-methodology" class="section level2" number="7.1">
<h2><span class="header-section-number">7.1</span> Data and methodology</h2>
<p>The available data for this experiment are weekly total-returns for all equity stocks included in the
Johannesburg Stock Exchange (JSE) All Share Index (ALSI) over the period ranging from the <span class="math inline">\(5^{th}\)</span>
January 1996 to the <span class="math inline">\(1^{st}\)</span> November 2019. Weightings of the shares in the ALSI are also available,
although this is a monthly series. This historical vector of the weights of the MW portfolio through
time is denoted <span class="math inline">\(\hat{w}^{\text{mw}}_t\)</span>.</p>
<p>The investigation uses a rolling estimation window of <span class="math inline">\(T = 400\)</span><a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a>
weekly observations to construct portfolios. Weekly data inputs are used with monthly rebalancing
because of the high data volume requirement from chapter <a href="somemaths.html#somemaths">6</a>. The constructed portfolio
<span class="math inline">\(\hat{w}_{t_i}\)</span> will be held out-of-sample over the interval <span class="math inline">\([t_i, t_{i + 1}]\)</span>, where <span class="math inline">\(t_i\)</span> denotes a
month’s end. The entire holding period is from the <span class="math inline">\(30^{th}\)</span> of September 2003 to the <span class="math inline">\(27^{th}\)</span> of
September 2019 a total of 16 years. Portfolios are constructed for two different asset universes;
namely, the <span class="math inline">\(40\)</span> largest stocks and the <span class="math inline">\(100\)</span> largest stocks. The separation is to test the effect on
portfolio performance of an investor broadening their universe. This methodology is outlined for each
rebalancing date:</p>
<ol style="list-style-type: decimal">
<li><p>Of the stocks in the ALSI with a data history of at least length <span class="math inline">\(T\)</span>, choose the <span class="math inline">\(N\)</span> stocks with the
largest market weights.</p></li>
<li><p>Use the <span class="math inline">\(N \times T\)</span> matrix of sample returns to find asset weights for the relevant
portfolio-technique pair.</p></li>
<li><p>Hold the found portfolio <span class="math inline">\(\hat{w}\)</span> for one month, record the returns <span class="math inline">\(\hat{r}\)</span>, and calculate the
portfolio turnover.</p></li>
</ol>
<p>This experiment is specific to this data and method. Therefore, it is important to outline some
limitations of the results. Although framework <a href="genframework.html#eq:genopt">(3.7)</a> is broad, this experiment only analyses
portfolios constructed with South African equity returns, and cannot be used to state facts about the
portfolio construction process generally. The budget, long-only and maximum weight constraints were all
applied for this experiment. Specifically the maximum weight constraint used is <span class="math inline">\(\alpha = 0.1\)</span>. The
choice intends to provide a consistent basis for comparison across portfolio-technique pairs and
ensures similarity to practical applications. Shares that have missing data were excluded at each
rebalancing date with a filter, therefore the MW portfolio, where <span class="math inline">\(N = 40\)</span> may not be representative of
the JSE Top 40 index. Transaction costs are ignored due to the liquid nature of the largest stocks,
although this is a potential area for future improvement on the backtesting methodology.</p>
</div>
<div id="results" class="section level2" number="7.2">
<h2><span class="header-section-number">7.2</span> Results</h2>
<p>Before the results are reported, specific metrics that illustrate the effect of each technique and
portfolio need to be introduced. The first is turnover (TO). It measures the magnitude of trading
required on each rebalancing date. If there are <span class="math inline">\(m\)</span> rebalancing dates, then the TO is calculated as:
<span class="math display">\[\begin{align}
\text{TO} &amp; = \frac{6}{(m - 1)} \sum_{i = 1}^{m - 1} \sum_{j =1}^{N} |\hat{w}_{t_i, j}^\triangle - \hat{w}_{t_i, j}|,
\end{align}\]</span>
where <span class="math inline">\(\hat{w}_{t_i, j}^\triangle\)</span> is the buy-and-hold weight of the <span class="math inline">\(j^{th}\)</span> asset just before the
rebalance at time <span class="math inline">\(t_i\)</span>. The turnover is annual and one-way only; hence, the scaling factor of
<span class="math inline">\(\frac{6}{m-1}\)</span>. For a higher TO, the investor has increased risk when rebalancing that they will not
enter into the new portfolio at the current market price. The maximum possible value of the TO is
<span class="math inline">\(1200\%\)</span>, and the investor achieves it if they switch from one single stock portfolio to another at
every rebalancing date.</p>
<p>The next reporting metric is maximum drawdown (MDD), the definition of which requires the notion of
cumulative wealth. The investor’s cumulative wealth at time <span class="math inline">\(t_j\)</span> is their return from time <span class="math inline">\(t_0\)</span>
until time <span class="math inline">\(t_j\)</span> on a portfolio of one initial unit investment, and it is defined as:
<span class="math display">\[\begin{align*}
W_{t_j} &amp;= \prod_{i = 1}^{j} (1 + \hat{r}_{t_i}), 
\end{align*}\]</span>
where <span class="math inline">\(\hat{r}_{t_i}\)</span> is the return realised over the interval <span class="math inline">\([t_{i - 1}, t_i)\)</span>. The MDD is the
biggest loss in cumulative wealth for the entire investment period, and is formulated as:
<span class="math display">\[\begin{align}
\text{MDD} &amp; = \underset{t_j \in \{t_1, ..., t_m\}}{\text{argmax}} \Big \{ \underset{t_i \in \{t_1, \text{...}, t_j\}}{\text{argmax} \{W_{t_i} \}} - W_{t_j}  \Big \} \; .
\end{align}\]</span>
MDD is an essential measure for money managers because excessive drawdowns lead to redemptions in
their funds. <span class="citation">(Magdon-Ismail and Atiya <a href="#ref-M04" role="doc-biblioref">2004</a>)</span></p>
<p>The last two measures are measures of concentration. As stated earlier, the risk-based investor is
making a trade-off between weight concentration and risk concentration. A standard for weight
concentration at a rebalancing date, the inverse Herfindahl index, has already been defined. But the
IHI is general and could apply to multiple types of weights. For allocation weights the IHI at time
<span class="math inline">\(t_i\)</span> is given as:
<span class="math display">\[\begin{align}
N^{\text{eff}}_{t_i} &amp;= \frac{1}{\sum_{j = 1}^N w_{t_i, j}^2} \; ,
\end{align}\]</span>
where $N^{}<em>{t_i} $ can be interpreted as the number of equal-weighted stocks the investor’s
portfolio is equivalent to. The notation reflects the idea that the IHI represents the number of
effective stocks in the portfolio. The upper bound of $N^{}</em>{t_i} $ is <span class="math inline">\(N\)</span> and the lower
bound in the presence of a maximum allocation constraint is:
<span class="math inline">\(({\lfloor \frac{1}{\alpha} \rfloor \cdot \alpha^2 + (1- \lfloor \frac{1}{\alpha}\rfloor \cdot \alpha)^2})^{-1}\)</span>
, which is derived in appendix <a href="portfolio-mathematics.html#ihimax">B.2</a>. For the case when <span class="math inline">\(\alpha = 0.1\)</span> the lower bound is
<span class="math inline">\(10\)</span>. Risk-weights can be taken instead of capital weights to measure the effectiveness of an asset on
portfolio volatility. Since the TRCs sum to the portfolio volatility, the risk contributions can be
scaled into risk-weights so that they sum to <span class="math inline">\(1\)</span>. The risk-weight for the <span class="math inline">\(j^{th}\)</span> asset at time <span class="math inline">\(t_i\)</span>
is given as:
<span class="math display">\[\begin{align}
\text{RW}_{t_i, j} &amp;= \frac{\text{TRC}_{t_i, j}}{\sqrt{w_{t_i}^\intercal \Sigma w_{t_i}}}\; ,
 \end{align}\]</span>
where the inverse Herfindahl index approach can be applied again. The risk-weight IHI is written as:
<span class="math display">\[\begin{align}
N^\mathrm{rw}_{t_i}(RW_{t_i}) &amp;= \frac{1}{\sum_{j = 1}^N \text{RW}_{t_i, j}^2} \;.
\end{align}\]</span>
If <span class="math inline">\(\Sigma\)</span> is positive semi-definite, then the lower bound is <span class="math inline">\(1\)</span> even in the presence of the maximum
allocation constraint, because one asset could have a positive weight and considerable volatility. The
upper bound is once again <span class="math inline">\(N\)</span>. The concentration measures are reported as averages across all of the
<span class="math inline">\(m\)</span> rebalancing dates.</p>
<p>Let us first discuss the results for the GMV portfolios. The main objective of constructing GMV
portfolios is to reduce the out-of-sample volatility of returns. The main aim of each GMV-technique
pair is the same, but performance is measured against the GMV-SCM pair. Therefore, it makes sense to
define a measure of each GMV-technique pair performance in the same way as <span class="citation">Richard and Roncalli (<a href="#ref-RR15" role="doc-biblioref">2015</a>)</span>, as a
volatility reduction over the GMV-SCM pair:
<span class="math display">\[\begin{align}
\mathcal{VR}(w|w_{\text{gmv-scm}}) &amp; = \frac{\sigma(w_{\text{gmv-scm}}) - \sigma(w)}{\sigma(w_{\text{gmv-scm}})},
\end{align}\]</span>
where the <span class="math inline">\(\sigma(\cdot)\)</span> function measures a portfolio’s volatility.</p>
<div id="going-to-rify" class="section level3" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> going to R’ify</h3>
</div>
</div>
<div id="code" class="section level2" number="7.3">
<h2><span class="header-section-number">7.3</span> Code</h2>
<div id="data-reading-in-and-cleaning" class="section level3" number="7.3.1">
<h3><span class="header-section-number">7.3.1</span> Data reading in and cleaning</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="experiment.html#cb8-1"></a><span class="kw">library</span>(readxl)</span>
<span id="cb8-2"><a href="experiment.html#cb8-2"></a><span class="kw">library</span>(tidyr)</span>
<span id="cb8-3"><a href="experiment.html#cb8-3"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb8-4"><a href="experiment.html#cb8-4"></a><span class="kw">library</span>(lubridate)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;lubridate&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:data.table&#39;:
## 
##     hour, isoweek, mday, minute, month, quarter, second, wday, week, yday, year</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     date, intersect, setdiff, union</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="experiment.html#cb12-1"></a><span class="kw">library</span>(magrittr)</span>
<span id="cb12-2"><a href="experiment.html#cb12-2"></a><span class="kw">library</span>(rlang)</span>
<span id="cb12-3"><a href="experiment.html#cb12-3"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb12-4"><a href="experiment.html#cb12-4"></a><span class="kw">library</span>(knitr)</span>
<span id="cb12-5"><a href="experiment.html#cb12-5"></a></span>
<span id="cb12-6"><a href="experiment.html#cb12-6"></a><span class="co"># sourcing data ------------------------------------------------------------------------------------</span></span>
<span id="cb12-7"><a href="experiment.html#cb12-7"></a>weekly_ret &lt;-<span class="st"> </span><span class="kw">read_xlsx</span>(</span>
<span id="cb12-8"><a href="experiment.html#cb12-8"></a>  <span class="st">&quot;data/data_emlyn.xlsx&quot;</span>,</span>
<span id="cb12-9"><a href="experiment.html#cb12-9"></a>  <span class="dt">sheet =</span> <span class="st">&quot;Weekly TRets&quot;</span>,</span>
<span id="cb12-10"><a href="experiment.html#cb12-10"></a>  <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;NaN&quot;</span>)</span>
<span id="cb12-11"><a href="experiment.html#cb12-11"></a>)</span></code></pre></div>
<pre><code>## New names:
## * `` -&gt; ...1</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="experiment.html#cb14-1"></a>month_ret &lt;-<span class="st"> </span><span class="kw">read_xlsx</span>(</span>
<span id="cb14-2"><a href="experiment.html#cb14-2"></a>  <span class="st">&quot;data/data_emlyn.xlsx&quot;</span>,</span>
<span id="cb14-3"><a href="experiment.html#cb14-3"></a>  <span class="dt">sheet =</span> <span class="st">&quot;Monthly TRets&quot;</span>,</span>
<span id="cb14-4"><a href="experiment.html#cb14-4"></a>  <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;NaN&quot;</span>)</span>
<span id="cb14-5"><a href="experiment.html#cb14-5"></a>)</span></code></pre></div>
<pre><code>## New names:
## * `` -&gt; ...1</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="experiment.html#cb16-1"></a>alsi_weights &lt;-<span class="st"> </span><span class="kw">read_xlsx</span>(</span>
<span id="cb16-2"><a href="experiment.html#cb16-2"></a>  <span class="st">&quot;data/data_emlyn.xlsx&quot;</span>,</span>
<span id="cb16-3"><a href="experiment.html#cb16-3"></a>  <span class="dt">sheet =</span> <span class="st">&quot;ALSI Weights&quot;</span>,</span>
<span id="cb16-4"><a href="experiment.html#cb16-4"></a>  <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;Nan&quot;</span>)</span>
<span id="cb16-5"><a href="experiment.html#cb16-5"></a>)</span></code></pre></div>
<pre><code>## New names:
## * `` -&gt; ...2</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="experiment.html#cb18-1"></a><span class="co"># cleaning data ------------------------------------------------------------------------------------</span></span>
<span id="cb18-2"><a href="experiment.html#cb18-2"></a>weekly_ret &lt;-<span class="st"> </span>weekly_ret <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-3"><a href="experiment.html#cb18-3"></a><span class="st">  </span><span class="kw">rename</span>(<span class="st">&quot;date&quot;</span> =<span class="st"> &quot;...1&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-4"><a href="experiment.html#cb18-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(.data<span class="op">$</span>date)) <span class="op">%&gt;%</span></span>
<span id="cb18-5"><a href="experiment.html#cb18-5"></a><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">setdiff</span>(<span class="kw">colnames</span>(weekly_ret), <span class="kw">c</span>(<span class="st">&quot;...1&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-6"><a href="experiment.html#cb18-6"></a><span class="st">  </span><span class="kw">drop_na</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-7"><a href="experiment.html#cb18-7"></a><span class="st">  </span><span class="kw">arrange</span>(.data<span class="op">$</span>date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-8"><a href="experiment.html#cb18-8"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">join_col =</span> <span class="kw">as.integer</span>(<span class="kw">format</span>(.data<span class="op">$</span>date, <span class="st">&#39;%Y%m&#39;</span>)))</span>
<span id="cb18-9"><a href="experiment.html#cb18-9"></a></span>
<span id="cb18-10"><a href="experiment.html#cb18-10"></a>month_ret &lt;-<span class="st"> </span>month_ret <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-11"><a href="experiment.html#cb18-11"></a><span class="st">  </span><span class="kw">rename</span>(<span class="st">&quot;date&quot;</span> =<span class="st"> &quot;...1&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-12"><a href="experiment.html#cb18-12"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(.data<span class="op">$</span>date)) <span class="op">%&gt;%</span></span>
<span id="cb18-13"><a href="experiment.html#cb18-13"></a><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">setdiff</span>(<span class="kw">colnames</span>(month_ret), <span class="kw">c</span>(<span class="st">&quot;...1&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-14"><a href="experiment.html#cb18-14"></a><span class="st">  </span><span class="kw">drop_na</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-15"><a href="experiment.html#cb18-15"></a><span class="st">  </span><span class="kw">arrange</span>(.data<span class="op">$</span>date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-16"><a href="experiment.html#cb18-16"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">join_col =</span> <span class="kw">as.integer</span>(<span class="kw">format</span>(.data<span class="op">$</span>date, <span class="st">&#39;%Y%m&#39;</span>)))</span>
<span id="cb18-17"><a href="experiment.html#cb18-17"></a></span>
<span id="cb18-18"><a href="experiment.html#cb18-18"></a>alsi_weights &lt;-<span class="st"> </span>alsi_weights <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-19"><a href="experiment.html#cb18-19"></a><span class="st">  </span><span class="kw">rename</span>(<span class="st">&quot;date&quot;</span> =<span class="st"> &quot;...2&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-20"><a href="experiment.html#cb18-20"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>.data<span class="op">$</span>SumCheck) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-21"><a href="experiment.html#cb18-21"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(.data<span class="op">$</span>date) <span class="op">+</span><span class="st"> </span><span class="dv">15</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># weights are at end of month, making start</span></span>
<span id="cb18-22"><a href="experiment.html#cb18-22"></a><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">setdiff</span>(<span class="kw">colnames</span>(alsi_weights), <span class="kw">c</span>(<span class="st">&quot;SumCheck&quot;</span>, <span class="st">&quot;...2&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-23"><a href="experiment.html#cb18-23"></a><span class="st">  </span><span class="kw">drop_na</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-24"><a href="experiment.html#cb18-24"></a><span class="st">  </span><span class="kw">arrange</span>(.data<span class="op">$</span>date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-25"><a href="experiment.html#cb18-25"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">join_col =</span> <span class="kw">as.integer</span>(<span class="kw">format</span>(.data<span class="op">$</span>date, <span class="st">&#39;%Y%m&#39;</span>)))</span>
<span id="cb18-26"><a href="experiment.html#cb18-26"></a></span>
<span id="cb18-27"><a href="experiment.html#cb18-27"></a><span class="co"># joining data -------------------------------------------------------------------------------------</span></span>
<span id="cb18-28"><a href="experiment.html#cb18-28"></a>full_ret &lt;-<span class="st"> </span>weekly_ret <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-29"><a href="experiment.html#cb18-29"></a><span class="st">  </span><span class="kw">left_join</span>(</span>
<span id="cb18-30"><a href="experiment.html#cb18-30"></a>    month_ret, </span>
<span id="cb18-31"><a href="experiment.html#cb18-31"></a>    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;join_col&quot;</span>, <span class="st">&quot;name&quot;</span>), </span>
<span id="cb18-32"><a href="experiment.html#cb18-32"></a>    <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;_week&quot;</span>, <span class="st">&quot;_month&quot;</span>)</span>
<span id="cb18-33"><a href="experiment.html#cb18-33"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-34"><a href="experiment.html#cb18-34"></a><span class="st">  </span><span class="kw">select</span>(</span>
<span id="cb18-35"><a href="experiment.html#cb18-35"></a>    <span class="dt">date =</span> .data<span class="op">$</span>date_week, </span>
<span id="cb18-36"><a href="experiment.html#cb18-36"></a>    .data<span class="op">$</span>name, </span>
<span id="cb18-37"><a href="experiment.html#cb18-37"></a>    <span class="dt">week_ret =</span> .data<span class="op">$</span>value_week, </span>
<span id="cb18-38"><a href="experiment.html#cb18-38"></a>    <span class="dt">month_ret =</span> .data<span class="op">$</span>value_month, </span>
<span id="cb18-39"><a href="experiment.html#cb18-39"></a>    .data<span class="op">$</span>join_col</span>
<span id="cb18-40"><a href="experiment.html#cb18-40"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-41"><a href="experiment.html#cb18-41"></a><span class="st">  </span><span class="kw">left_join</span>(</span>
<span id="cb18-42"><a href="experiment.html#cb18-42"></a>    alsi_weights,</span>
<span id="cb18-43"><a href="experiment.html#cb18-43"></a>    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;join_col&quot;</span>, <span class="st">&quot;name&quot;</span>),</span>
<span id="cb18-44"><a href="experiment.html#cb18-44"></a>    <span class="dt">suffix =</span> <span class="kw">c</span>(<span class="st">&quot;_full&quot;</span>, <span class="st">&quot;_weights&quot;</span>)</span>
<span id="cb18-45"><a href="experiment.html#cb18-45"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-46"><a href="experiment.html#cb18-46"></a><span class="st">  </span><span class="kw">select</span>(</span>
<span id="cb18-47"><a href="experiment.html#cb18-47"></a>    <span class="dt">date =</span> .data<span class="op">$</span>date_full,</span>
<span id="cb18-48"><a href="experiment.html#cb18-48"></a>    .data<span class="op">$</span>name,</span>
<span id="cb18-49"><a href="experiment.html#cb18-49"></a>    .data<span class="op">$</span>week_ret,</span>
<span id="cb18-50"><a href="experiment.html#cb18-50"></a>    .data<span class="op">$</span>month_ret,</span>
<span id="cb18-51"><a href="experiment.html#cb18-51"></a>    <span class="dt">month_weight_start =</span> .data<span class="op">$</span>value,</span>
<span id="cb18-52"><a href="experiment.html#cb18-52"></a>    <span class="dt">month_index =</span> .data<span class="op">$</span>join_col</span>
<span id="cb18-53"><a href="experiment.html#cb18-53"></a>  )</span>
<span id="cb18-54"><a href="experiment.html#cb18-54"></a></span>
<span id="cb18-55"><a href="experiment.html#cb18-55"></a><span class="co"># keeping complete cases only ----------------------------------------------------------------------</span></span>
<span id="cb18-56"><a href="experiment.html#cb18-56"></a></span>
<span id="cb18-57"><a href="experiment.html#cb18-57"></a>complete_per &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">complete.cases</span>(full_ret))<span class="op">/</span><span class="kw">nrow</span>(full_ret)</span>
<span id="cb18-58"><a href="experiment.html#cb18-58"></a><span class="co"># data is 98.2% complete</span></span>
<span id="cb18-59"><a href="experiment.html#cb18-59"></a></span>
<span id="cb18-60"><a href="experiment.html#cb18-60"></a>incomp_weight_per &lt;-<span class="st"> </span><span class="kw">sum</span>(full_ret[<span class="op">!</span><span class="kw">complete.cases</span>(full_ret),]<span class="op">$</span>month_weight_start, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">/</span><span class="st"> </span></span>
<span id="cb18-61"><a href="experiment.html#cb18-61"></a><span class="st">  </span><span class="kw">sum</span>(full_ret<span class="op">$</span>month_weight_start, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb18-62"><a href="experiment.html#cb18-62"></a><span class="co"># but only 0.2% of the weight is in the incomplete data, so it is largely</span></span>
<span id="cb18-63"><a href="experiment.html#cb18-63"></a><span class="co"># isolated to the long tail of small stocks that are outside of the</span></span>
<span id="cb18-64"><a href="experiment.html#cb18-64"></a><span class="co"># top 40 and 100 and are therefore not needed in this research</span></span>
<span id="cb18-65"><a href="experiment.html#cb18-65"></a></span>
<span id="cb18-66"><a href="experiment.html#cb18-66"></a>full_ret &lt;-<span class="st"> </span>full_ret[<span class="kw">complete.cases</span>(full_ret),]</span>
<span id="cb18-67"><a href="experiment.html#cb18-67"></a></span>
<span id="cb18-68"><a href="experiment.html#cb18-68"></a><span class="co"># plot coverage</span></span>
<span id="cb18-69"><a href="experiment.html#cb18-69"></a>full_ret <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-70"><a href="experiment.html#cb18-70"></a><span class="st">  </span><span class="kw">filter</span>(.data<span class="op">$</span>month_weight_start <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-71"><a href="experiment.html#cb18-71"></a><span class="st">  </span><span class="kw">group_by</span>(date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-72"><a href="experiment.html#cb18-72"></a><span class="st">  </span><span class="kw">count</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-73"><a href="experiment.html#cb18-73"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(.data<span class="op">$</span>date, .data<span class="op">$</span>n)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb18-74"><a href="experiment.html#cb18-74"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb18-75"><a href="experiment.html#cb18-75"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;coverage through time&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/data_read_init-1.png" width="672" /></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="experiment.html#cb19-1"></a><span class="co"># getting indices ----------------------------------------------------------------------------------</span></span>
<span id="cb19-2"><a href="experiment.html#cb19-2"></a></span>
<span id="cb19-3"><a href="experiment.html#cb19-3"></a>top40_month_weights &lt;-<span class="st"> </span>full_ret <span class="op">%&gt;%</span></span>
<span id="cb19-4"><a href="experiment.html#cb19-4"></a><span class="st">  </span><span class="kw">group_by</span>(.data<span class="op">$</span>month_index) <span class="op">%&gt;%</span></span>
<span id="cb19-5"><a href="experiment.html#cb19-5"></a><span class="st">    </span><span class="kw">filter</span>(.data<span class="op">$</span>date <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(.data<span class="op">$</span>date)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-6"><a href="experiment.html#cb19-6"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">size_order =</span> <span class="kw">rank</span>(<span class="op">-</span>.data<span class="op">$</span>month_weight_start)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-7"><a href="experiment.html#cb19-7"></a><span class="st">    </span><span class="kw">filter</span>(.data<span class="op">$</span>size_order <span class="op">&lt;=</span><span class="st"> </span><span class="dv">40</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-8"><a href="experiment.html#cb19-8"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">top40_weight =</span> .data<span class="op">$</span>month_weight_start <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(.data<span class="op">$</span>month_weight_start)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-9"><a href="experiment.html#cb19-9"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-10"><a href="experiment.html#cb19-10"></a><span class="st">  </span><span class="kw">select</span>(.data<span class="op">$</span>month_index, .data<span class="op">$</span>name, .data<span class="op">$</span>top40_weight)</span>
<span id="cb19-11"><a href="experiment.html#cb19-11"></a></span>
<span id="cb19-12"><a href="experiment.html#cb19-12"></a></span>
<span id="cb19-13"><a href="experiment.html#cb19-13"></a>top100_month_weights &lt;-<span class="st"> </span>full_ret <span class="op">%&gt;%</span></span>
<span id="cb19-14"><a href="experiment.html#cb19-14"></a><span class="st">  </span><span class="kw">group_by</span>(.data<span class="op">$</span>month_index) <span class="op">%&gt;%</span></span>
<span id="cb19-15"><a href="experiment.html#cb19-15"></a><span class="st">  </span><span class="kw">filter</span>(.data<span class="op">$</span>date <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(.data<span class="op">$</span>date)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-16"><a href="experiment.html#cb19-16"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">size_order =</span> <span class="kw">rank</span>(<span class="op">-</span>.data<span class="op">$</span>month_weight_start)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-17"><a href="experiment.html#cb19-17"></a><span class="st">  </span><span class="kw">filter</span>(.data<span class="op">$</span>size_order <span class="op">&lt;=</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-18"><a href="experiment.html#cb19-18"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">top100_weight =</span> .data<span class="op">$</span>month_weight_start <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(.data<span class="op">$</span>month_weight_start)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-19"><a href="experiment.html#cb19-19"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-20"><a href="experiment.html#cb19-20"></a><span class="st">  </span><span class="kw">select</span>(.data<span class="op">$</span>month_index, .data<span class="op">$</span>name, .data<span class="op">$</span>top100_weight)</span>
<span id="cb19-21"><a href="experiment.html#cb19-21"></a></span>
<span id="cb19-22"><a href="experiment.html#cb19-22"></a></span>
<span id="cb19-23"><a href="experiment.html#cb19-23"></a>full_ret &lt;-<span class="st"> </span>full_ret <span class="op">%&gt;%</span></span>
<span id="cb19-24"><a href="experiment.html#cb19-24"></a><span class="st">  </span><span class="kw">full_join</span>(</span>
<span id="cb19-25"><a href="experiment.html#cb19-25"></a>    top40_month_weights,</span>
<span id="cb19-26"><a href="experiment.html#cb19-26"></a>    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;month_index&quot;</span>, <span class="st">&quot;name&quot;</span>)</span>
<span id="cb19-27"><a href="experiment.html#cb19-27"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb19-28"><a href="experiment.html#cb19-28"></a><span class="st">  </span><span class="kw">full_join</span>(</span>
<span id="cb19-29"><a href="experiment.html#cb19-29"></a>    top100_month_weights,</span>
<span id="cb19-30"><a href="experiment.html#cb19-30"></a>    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;month_index&quot;</span>, <span class="st">&quot;name&quot;</span>)</span>
<span id="cb19-31"><a href="experiment.html#cb19-31"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb19-32"><a href="experiment.html#cb19-32"></a><span class="st">  </span><span class="kw">select</span>(</span>
<span id="cb19-33"><a href="experiment.html#cb19-33"></a>    .data<span class="op">$</span>date,</span>
<span id="cb19-34"><a href="experiment.html#cb19-34"></a>    .data<span class="op">$</span>name,</span>
<span id="cb19-35"><a href="experiment.html#cb19-35"></a>    .data<span class="op">$</span>week_ret,</span>
<span id="cb19-36"><a href="experiment.html#cb19-36"></a>    .data<span class="op">$</span>month_ret,</span>
<span id="cb19-37"><a href="experiment.html#cb19-37"></a>    .data<span class="op">$</span>top40_weight,</span>
<span id="cb19-38"><a href="experiment.html#cb19-38"></a>    .data<span class="op">$</span>top100_weight,</span>
<span id="cb19-39"><a href="experiment.html#cb19-39"></a>    <span class="dt">alsi_weight =</span> .data<span class="op">$</span>month_weight_start,</span>
<span id="cb19-40"><a href="experiment.html#cb19-40"></a>    .data<span class="op">$</span>month_index</span>
<span id="cb19-41"><a href="experiment.html#cb19-41"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb19-42"><a href="experiment.html#cb19-42"></a><span class="st">  </span><span class="kw">replace_na</span>(<span class="kw">list</span>(<span class="dt">top40_weight =</span> <span class="dv">0</span>, <span class="dt">top100_weight =</span> <span class="dv">0</span>))</span>
<span id="cb19-43"><a href="experiment.html#cb19-43"></a></span>
<span id="cb19-44"><a href="experiment.html#cb19-44"></a><span class="kw">saveRDS</span>(full_ret, <span class="dt">file =</span> <span class="st">&quot;data/full_ret.rds&quot;</span>)</span>
<span id="cb19-45"><a href="experiment.html#cb19-45"></a></span>
<span id="cb19-46"><a href="experiment.html#cb19-46"></a><span class="kw">head</span>(full_ret, <span class="dv">10</span>)</span></code></pre></div>
<pre><code>## # A tibble: 10 x 8
##    date       name  week_ret month_ret top40_weight top100_weight alsi_weight month_index
##    &lt;date&gt;     &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;       &lt;int&gt;
##  1 1996-02-02 ABI    -0.0314    0.0133      0           0.00104     0.000922       199602
##  2 1996-02-02 AXL     0.0436    0.0436      0           0           0              199602
##  3 1996-02-02 ACL    -0.0886    0.0218      0           0           0              199602
##  4 1996-02-02 ACT     0         0.0833      0           0           0              199602
##  5 1996-02-02 ADR     0         0.250       0           0.0000499   0.0000440      199602
##  6 1996-02-02 AEL     0.0208   -0.265       0           0           0              199602
##  7 1996-02-02 AEN     0.0455   -0.130       0           0           0              199602
##  8 1996-02-02 AFE    -0.0545   -0.106       0.00626     0.00598     0.00528        199602
##  9 1996-02-02 AFI     0         0.105       0           0.00109     0.000961       199602
## 10 1996-02-02 AFL     0         0           0           0           0              199602</code></pre>
</div>
<div id="data-preparation-sample-window-history-adjustment" class="section level3" number="7.3.2">
<h3><span class="header-section-number">7.3.2</span> Data preparation (sample window history adjustment)</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="experiment.html#cb21-1"></a><span class="kw">library</span>(rlang)</span>
<span id="cb21-2"><a href="experiment.html#cb21-2"></a><span class="kw">library</span>(magrittr)</span>
<span id="cb21-3"><a href="experiment.html#cb21-3"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb21-4"><a href="experiment.html#cb21-4"></a><span class="kw">library</span>(data.table)</span>
<span id="cb21-5"><a href="experiment.html#cb21-5"></a><span class="kw">library</span>(tidyr)</span>
<span id="cb21-6"><a href="experiment.html#cb21-6"></a></span>
<span id="cb21-7"><a href="experiment.html#cb21-7"></a>full_ret &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;data/full_ret.rds&quot;</span>)</span>
<span id="cb21-8"><a href="experiment.html#cb21-8"></a>sample_est_wind &lt;-<span class="st"> </span><span class="dv">400</span></span>
<span id="cb21-9"><a href="experiment.html#cb21-9"></a></span>
<span id="cb21-10"><a href="experiment.html#cb21-10"></a>rebal_est_ranges &lt;-<span class="st"> </span>full_ret <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-11"><a href="experiment.html#cb21-11"></a><span class="st">  </span><span class="kw">select</span>(.data<span class="op">$</span>date, .data<span class="op">$</span>month_index) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-12"><a href="experiment.html#cb21-12"></a><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-13"><a href="experiment.html#cb21-13"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">start_date =</span> <span class="kw">shift</span>(.data<span class="op">$</span>date, sample_est_wind)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-14"><a href="experiment.html#cb21-14"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">end_date =</span> <span class="kw">shift</span>(.data<span class="op">$</span>date, <span class="dv">1</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-15"><a href="experiment.html#cb21-15"></a><span class="st">  </span><span class="kw">na.omit</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-16"><a href="experiment.html#cb21-16"></a><span class="st">  </span><span class="kw">group_by</span>(.data<span class="op">$</span>month_index) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-17"><a href="experiment.html#cb21-17"></a><span class="st">    </span><span class="kw">filter</span>(.data<span class="op">$</span>date <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(.data<span class="op">$</span>date)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-18"><a href="experiment.html#cb21-18"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb21-19"><a href="experiment.html#cb21-19"></a><span class="st">  </span><span class="kw">select</span>(.data<span class="op">$</span>month_index, .data<span class="op">$</span>start_date, .data<span class="op">$</span>end_date)</span>
<span id="cb21-20"><a href="experiment.html#cb21-20"></a></span>
<span id="cb21-21"><a href="experiment.html#cb21-21"></a>model_rebal_dat &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">month_index =</span> rebal_est_ranges<span class="op">$</span>month_index, <span class="dt">data =</span> <span class="kw">list</span>(<span class="ot">NULL</span>))</span>
<span id="cb21-22"><a href="experiment.html#cb21-22"></a></span>
<span id="cb21-23"><a href="experiment.html#cb21-23"></a><span class="co"># Looping through to find data</span></span>
<span id="cb21-24"><a href="experiment.html#cb21-24"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(rebal_est_ranges<span class="op">$</span>month_index)) {</span>
<span id="cb21-25"><a href="experiment.html#cb21-25"></a>  <span class="co"># need to find full data histories first</span></span>
<span id="cb21-26"><a href="experiment.html#cb21-26"></a>  full_hist_ids &lt;-<span class="st"> </span>full_ret <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-27"><a href="experiment.html#cb21-27"></a><span class="st">    </span><span class="kw">filter</span>(.data<span class="op">$</span>date <span class="op">&lt;=</span><span class="st"> </span>rebal_est_ranges[i, ]<span class="op">$</span>end_date <span class="op">&amp;</span><span class="st"> </span></span>
<span id="cb21-28"><a href="experiment.html#cb21-28"></a><span class="st">             </span>.data<span class="op">$</span>date <span class="op">&gt;=</span><span class="st"> </span>rebal_est_ranges[i, ]<span class="op">$</span>start_date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-29"><a href="experiment.html#cb21-29"></a><span class="st">    </span><span class="kw">group_by</span>(.data<span class="op">$</span>name) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-30"><a href="experiment.html#cb21-30"></a><span class="st">    </span><span class="kw">count</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-31"><a href="experiment.html#cb21-31"></a><span class="st">    </span><span class="kw">filter</span>(.data<span class="op">$</span>n <span class="op">==</span><span class="st"> </span>sample_est_wind) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-32"><a href="experiment.html#cb21-32"></a><span class="st">    </span><span class="kw">pull</span>(.data<span class="op">$</span>name)</span>
<span id="cb21-33"><a href="experiment.html#cb21-33"></a>  <span class="co"># then we can use %in% to get those with full histories</span></span>
<span id="cb21-34"><a href="experiment.html#cb21-34"></a>  dat_now &lt;-<span class="st"> </span>full_ret <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-35"><a href="experiment.html#cb21-35"></a><span class="st">    </span><span class="kw">filter</span>(.data<span class="op">$</span>date <span class="op">&lt;=</span><span class="st"> </span>rebal_est_ranges[i, ]<span class="op">$</span>end_date <span class="op">&amp;</span><span class="st"> </span></span>
<span id="cb21-36"><a href="experiment.html#cb21-36"></a><span class="st">             </span>.data<span class="op">$</span>date <span class="op">&gt;=</span><span class="st"> </span>rebal_est_ranges[i, ]<span class="op">$</span>start_date <span class="op">&amp;</span></span>
<span id="cb21-37"><a href="experiment.html#cb21-37"></a><span class="st">             </span>.data<span class="op">$</span>name <span class="op">%in%</span><span class="st"> </span>full_hist_ids)</span>
<span id="cb21-38"><a href="experiment.html#cb21-38"></a>  <span class="co"># then re-allocate weights</span></span>
<span id="cb21-39"><a href="experiment.html#cb21-39"></a>  hist_adj_weights40 &lt;-<span class="st"> </span>dat_now <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-40"><a href="experiment.html#cb21-40"></a><span class="st">    </span><span class="kw">group_by</span>(.data<span class="op">$</span>month_index) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-41"><a href="experiment.html#cb21-41"></a><span class="st">      </span><span class="kw">filter</span>(.data<span class="op">$</span>date <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(.data<span class="op">$</span>date)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-42"><a href="experiment.html#cb21-42"></a><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">size_order =</span> <span class="kw">rank</span>(<span class="op">-</span>.data<span class="op">$</span>alsi_weight)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-43"><a href="experiment.html#cb21-43"></a><span class="st">      </span><span class="kw">filter</span>(.data<span class="op">$</span>size_order <span class="op">&lt;=</span><span class="st"> </span><span class="dv">40</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-44"><a href="experiment.html#cb21-44"></a><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">histadj_top40_weight =</span> .data<span class="op">$</span>alsi_weight <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(.data<span class="op">$</span>alsi_weight)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-45"><a href="experiment.html#cb21-45"></a><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-46"><a href="experiment.html#cb21-46"></a><span class="st">    </span><span class="kw">select</span>(.data<span class="op">$</span>month_index, .data<span class="op">$</span>name, .data<span class="op">$</span>histadj_top40_weight)</span>
<span id="cb21-47"><a href="experiment.html#cb21-47"></a>  hist_adj_weights100 &lt;-<span class="st"> </span>dat_now <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-48"><a href="experiment.html#cb21-48"></a><span class="st">    </span><span class="kw">group_by</span>(.data<span class="op">$</span>month_index) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-49"><a href="experiment.html#cb21-49"></a><span class="st">      </span><span class="kw">filter</span>(.data<span class="op">$</span>date <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(.data<span class="op">$</span>date)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-50"><a href="experiment.html#cb21-50"></a><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">size_order =</span> <span class="kw">rank</span>(<span class="op">-</span>.data<span class="op">$</span>alsi_weight)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-51"><a href="experiment.html#cb21-51"></a><span class="st">      </span><span class="kw">filter</span>(.data<span class="op">$</span>size_order <span class="op">&lt;=</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-52"><a href="experiment.html#cb21-52"></a><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">histadj_top100_weight =</span> .data<span class="op">$</span>alsi_weight <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(.data<span class="op">$</span>alsi_weight)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-53"><a href="experiment.html#cb21-53"></a><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-54"><a href="experiment.html#cb21-54"></a><span class="st">    </span><span class="kw">select</span>(.data<span class="op">$</span>month_index, .data<span class="op">$</span>name, .data<span class="op">$</span>histadj_top100_weight)</span>
<span id="cb21-55"><a href="experiment.html#cb21-55"></a>  <span class="co"># join back and prepare to save down</span></span>
<span id="cb21-56"><a href="experiment.html#cb21-56"></a>  dat_out &lt;-<span class="st"> </span>dat_now <span class="op">%&gt;%</span></span>
<span id="cb21-57"><a href="experiment.html#cb21-57"></a><span class="st">  </span><span class="kw">full_join</span>(</span>
<span id="cb21-58"><a href="experiment.html#cb21-58"></a>    hist_adj_weights40,</span>
<span id="cb21-59"><a href="experiment.html#cb21-59"></a>    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;month_index&quot;</span>, <span class="st">&quot;name&quot;</span>)</span>
<span id="cb21-60"><a href="experiment.html#cb21-60"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb21-61"><a href="experiment.html#cb21-61"></a><span class="st">  </span><span class="kw">full_join</span>(</span>
<span id="cb21-62"><a href="experiment.html#cb21-62"></a>    hist_adj_weights100,</span>
<span id="cb21-63"><a href="experiment.html#cb21-63"></a>    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;month_index&quot;</span>, <span class="st">&quot;name&quot;</span>)</span>
<span id="cb21-64"><a href="experiment.html#cb21-64"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb21-65"><a href="experiment.html#cb21-65"></a><span class="st">  </span><span class="kw">select</span>(</span>
<span id="cb21-66"><a href="experiment.html#cb21-66"></a>    .data<span class="op">$</span>date,</span>
<span id="cb21-67"><a href="experiment.html#cb21-67"></a>    .data<span class="op">$</span>name,</span>
<span id="cb21-68"><a href="experiment.html#cb21-68"></a>    .data<span class="op">$</span>week_ret,</span>
<span id="cb21-69"><a href="experiment.html#cb21-69"></a>    .data<span class="op">$</span>month_ret,</span>
<span id="cb21-70"><a href="experiment.html#cb21-70"></a>    .data<span class="op">$</span>histadj_top40_weight,</span>
<span id="cb21-71"><a href="experiment.html#cb21-71"></a>    .data<span class="op">$</span>histadj_top100_weight,</span>
<span id="cb21-72"><a href="experiment.html#cb21-72"></a>    .data<span class="op">$</span>month_index</span>
<span id="cb21-73"><a href="experiment.html#cb21-73"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb21-74"><a href="experiment.html#cb21-74"></a><span class="st">  </span><span class="kw">replace_na</span>(<span class="kw">list</span>(<span class="dt">histadj_top40_weight =</span> <span class="dv">0</span>, <span class="dt">histadj_top100_weight =</span> <span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-75"><a href="experiment.html#cb21-75"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">month_index =</span> rebal_est_ranges[i, ]<span class="op">$</span>month_index) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-76"><a href="experiment.html#cb21-76"></a><span class="st">  </span><span class="kw">nest</span>(<span class="dt">data =</span> <span class="kw">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;name&quot;</span>, <span class="st">&quot;week_ret&quot;</span>, <span class="st">&quot;month_ret&quot;</span>, <span class="st">&quot;histadj_top40_weight&quot;</span>, <span class="st">&quot;histadj_top100_weight&quot;</span>))</span>
<span id="cb21-77"><a href="experiment.html#cb21-77"></a>  model_rebal_dat[i, ] &lt;-<span class="st"> </span>dat_out[<span class="dv">1</span>, ]</span>
<span id="cb21-78"><a href="experiment.html#cb21-78"></a>}</span>
<span id="cb21-79"><a href="experiment.html#cb21-79"></a></span>
<span id="cb21-80"><a href="experiment.html#cb21-80"></a><span class="kw">saveRDS</span>(model_rebal_dat, <span class="dt">file =</span> <span class="st">&quot;data/model_rebal_dat.rds&quot;</span>)</span>
<span id="cb21-81"><a href="experiment.html#cb21-81"></a><span class="kw">head</span>(model_rebal_dat, <span class="dv">6</span>)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   month_index data                 
##         &lt;int&gt; &lt;list&gt;               
## 1      200310 &lt;tibble [56,400 × 6]&gt;
## 2      200311 &lt;tibble [56,400 × 6]&gt;
## 3      200312 &lt;tibble [56,800 × 6]&gt;
## 4      200401 &lt;tibble [57,200 × 6]&gt;
## 5      200402 &lt;tibble [57,600 × 6]&gt;
## 6      200403 &lt;tibble [57,600 × 6]&gt;</code></pre>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-M04">
<p>Magdon-Ismail, Malik, and Amir F Atiya. 2004. “Maximum Drawdown.” <em>Risk Magazine</em> 17 (10): 99–102.</p>
</div>
<div id="ref-RR15">
<p>Richard, Jean-Charles, and Thierry Roncalli. 2015. “Smart Beta: Managing Diversification of Minimum Variance Portfolios.” In <em>Risk-Based and Factor Investing</em>, 31–63. Elsevier.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="8">
<li id="fn8"><p><span class="math inline">\(400\)</span> weeks or <span class="math inline">\(7.69\)</span> years
may seem like an odd choice. It is a window that balances the need for enough estimation data, but also
a lengthy out-of-sample test. For a longer data history, a larger estimation window could be used.<a href="experiment.html#fnref8" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="somemaths.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="conclusion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="book_assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="book_assets/gitbook-2.6.7/js/lunr.js"></script>
<script src="book_assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="book_assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="book_assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "night",
"family": "sans",
"size": 14
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
